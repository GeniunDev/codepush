version: '3.8'

services:
  codepush-server:
    build: .
    container_name: codepush-server
    restart: unless-stopped
    environment:
      # This activates our new LocalStorage database
      - STORAGE_DIR=${STORAGE_DIR:-/storage}

      # The server URL pointing to localhost or your domain
      - SERVER_URL=${SERVER_URL:-http://localhost:3000}

      # GitHub OAuth
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}

      # Automatically connect to redis within the docker network
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}

      # Other Configuration
      - UPLOAD_SIZE_LIMIT_MB=${UPLOAD_SIZE_LIMIT_MB:-200}
      - ENABLE_ACCOUNT_REGISTRATION=${ENABLE_ACCOUNT_REGISTRATION:-true}
      - REFRESH_CREDENTIALS_INTERVAL=${REFRESH_CREDENTIALS_INTERVAL:-10}

    volumes:
      # Map the physical host volume to the container
      - storage_data:/storage

    networks:
      - codepush_network

    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    container_name: codepush-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data

    networks:
      - codepush_network

volumes:
  redis_data:
  storage_data:

networks:
  codepush_network:
    driver: bridge